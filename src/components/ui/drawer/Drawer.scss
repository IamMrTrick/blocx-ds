/* Drawer Component - Modern glassmorphism design with smooth animations */

/* GLOBAL: Prevent pull-to-refresh when any drawer is active */
html {
  overscroll-behavior-y: auto; /* Default for normal browsing */
}

html.drawer-active {
  overscroll-behavior: none;
  -webkit-overscroll-behavior: none;
  overscroll-behavior-y: none;
  -webkit-overscroll-behavior-y: none;
}

/* Mobile viewport stability - address dynamic viewport changes */
@supports (height: 100dvh) {
  .drawer {
    height: 100dvh; /* Use dynamic viewport height when supported */
  }
}

/* Fallback for older browsers */
@supports not (height: 100dvh) {
  .drawer {
    height: 100vh;
    /* Fix iOS Safari viewport issues */
    height: calc(var(--vh, 1vh) * 100);
  }
}

.drawer {
  /* Local vars - Enhanced for modern look */
  --_backdrop-bg: var(--transparent-black-50);
  --_backdrop-blur: blur(12px);
  --_panel-bg: var(--color-surface);
  --_panel-bg-dark: var(--bg-primary);
  --_panel-color: var(--color-text);
  --_panel-radius: var(--gl-radius-wrapper);
  --_panel-border: 1px solid var(--color-border-subtle);
  --_panel-border-dark: 1px solid var(--border-secondary);
  --_shadow: 0 32px 64px var(--shadow-lg), 
             0 16px 32px var(--shadow-md),
             0 8px 16px var(--shadow-sm);
  --_shadow-hover: 0 40px 80px var(--shadow-xl), 
                   0 20px 40px var(--shadow-lg),
                   0 10px 20px var(--shadow-md);
  --_gap: var(--spacing-12);
  --_pad: var(--spacing-20);
  --_panel-w: min(86vw, 420px);
  --_panel-h: 75vh;
  /* Elastic scaling (axis-based) */
  --drawer-scale-x: 1;
  --drawer-scale-y: 1;
  --_duration-fast: 0.3s;
  --_duration-medium: 0.45s;
  --_curve-ease-out: cubic-bezier(0.22, 1, 0.36, 1); /* A very smooth ease-out quint */

  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: var(--z-drawer);
  display: block; /* Keep in DOM to allow transition from initial transform */
  pointer-events: none; /* Disabled until open */
  overflow: clip; /* Prevent any overflow issues and avoid scrollbars on transform */
}

.drawer--open { 
  pointer-events: auto;
}

.drawer__backdrop {
  position: absolute;
  inset: 0;
  background: var(--_backdrop-bg);
  backdrop-filter: var(--_backdrop-blur) saturate(120%);
  -webkit-backdrop-filter: var(--_backdrop-blur) saturate(120%);
  opacity: 0;
  transition: opacity 0.3s ease-out;
}

.drawer--open .drawer__backdrop { 
  opacity: 1; 
}

.drawer__panel {
  position: absolute;
  background: var(--_panel-bg);
  color: var(--_panel-color);
  border: var(--_panel-border);
  border-radius: var(--_panel-radius);
  box-shadow: var(--_shadow);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  display: flex;
  flex-direction: column;
  gap: var(--_gap);
  padding: var(--_pad);
  /* Transition moved to separate rule */
  will-change: transform, opacity;
  overflow: hidden; /* Ensure panel doesn't cause page overflow */
  max-width: 100vw;
  max-height: 100vh;
  contain: layout paint size style; /* isolate for perf */
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
  .drawer__panel {
    background: var(--_panel-bg-dark);
    border: var(--_panel-border-dark);
  }
}

/* Sides with smooth drawer-like sliding */
.drawer--side-left .drawer__panel {
  inset-block: 0;
  inset-inline-start: 0;
  width: var(--_panel-w);
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  transform-origin: left center;
  transform: translate3d(-100%, 0, 0);
  opacity: 0;
}

.drawer--side-right .drawer__panel {
  inset-block: 0;
  inset-inline-end: 0;
  width: var(--_panel-w);
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
  transform-origin: right center;
  transform: translate3d(100%, 0, 0);
  opacity: 0;
}

.drawer--side-top .drawer__panel {
  inset-inline: 0;
  inset-block-start: 0;
  height: var(--_panel-h);
  border-top-left-radius: 0;
  border-top-right-radius: 0;
  transform-origin: center top;
  transform: translate3d(0, -100%, 0);
  opacity: 0;
}

.drawer--side-bottom .drawer__panel {
  inset-inline: 0;
  /* Use both modern and fallback positioning for mobile stability */
  inset-block-end: 0;
  bottom: calc(var(--drawer-bottom-offset, 0px) + env(safe-area-inset-bottom, 0px));
  height: var(--_panel-h);
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
  transform-origin: center bottom;
  transform: translate3d(0, 100%, 0);
  opacity: 0;
  /* Mobile browser stability fixes */
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  /* Safari-specific positioning fix - combine with slide animation */
  -webkit-transform: translate3d(0, 100%, 0);
  transform: translate3d(0, 100%, 0);
  /* Force hardware acceleration and stability */
  will-change: transform, opacity;
  transform-style: preserve-3d;
}

.drawer__panel {
  /* Always have transition for smooth animations */
  transition: transform var(--_duration-medium) var(--_curve-ease-out),
              opacity var(--_duration-fast) ease-out,
              height var(--_duration-medium) var(--_curve-ease-out), /* Add height transition */
              box-shadow var(--_duration-fast) ease-out;
  will-change: transform, opacity, height;
  backface-visibility: hidden;
}



.drawer--open .drawer__panel {
  opacity: 1;
  transform: translate3d(0, 0, 0);
  box-shadow: var(--_shadow-hover);
}

/* Hover effects for interactive elements */
.drawer__panel:hover {
  box-shadow: var(--_shadow-hover);
}

/* Sizes (affect width/height depending on side) */
.drawer--size-s.drawer--side-left .drawer__panel,
.drawer--size-s.drawer--side-right .drawer__panel { width: min(78vw, 340px); }
.drawer--size-m.drawer--side-left .drawer__panel,
.drawer--size-m.drawer--side-right .drawer__panel { width: min(86vw, 420px); }
.drawer--size-l.drawer--side-left .drawer__panel,
.drawer--size-l.drawer--side-right .drawer__panel { width: min(92vw, 520px); }
.drawer--size-xl.drawer--side-left .drawer__panel,
.drawer--size-xl.drawer--side-right .drawer__panel { width: min(96vw, 680px); }

.drawer--size-s.drawer--side-top .drawer__panel,
.drawer--size-s.drawer--side-bottom .drawer__panel { height: 55vh; }
.drawer--size-m.drawer--side-top .drawer__panel,
.drawer--size-m.drawer--side-bottom .drawer__panel { height: 65vh; }
.drawer--size-l.drawer--side-top .drawer__panel,
.drawer--size-l.drawer--side-bottom .drawer__panel { height: 75vh; }
.drawer--size-xl.drawer--side-top .drawer__panel,
.drawer--size-xl.drawer--side-bottom .drawer__panel { height: 88vh; }

.drawer--fullscreen .drawer__panel {
  inset: 0;
  border-radius: 0;
}

.drawer__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.drawer__title { margin: 0; font-size: var(--text-lg-size); line-height: var(--text-lg-line); }
.drawer__description { margin: 0; color: var(--text-secondary); font-size: var(--text-sm-size); line-height: var(--text-sm-line); }
.drawer__body {
  flex: 1 1 auto;
  min-height: 0;
  
  &[data-scrollable="true"] {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    /* Allow normal vertical scrolling */
    touch-action: pan-y;
    overscroll-behavior-y: contain; /* Prevent overscroll but allow scroll */
  }
  
  &[data-scrollable="false"] {
    overflow: hidden;
    touch-action: none;
  }
}
.drawer__footer {
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-8);
  /* keep footer visible at bottom of panel while body scrolls */
  margin-top: auto;
  position: sticky;
  bottom: 0;
  background: inherit;
  z-index: 2;
  /* safe-area padding */
  padding-bottom: calc(var(--spacing-16) + env(safe-area-inset-bottom, 0px));
}

/* ðŸ“± MOBILE OPTIMIZATION: Touch and overscroll behavior */

/* Different touch-action for different sides */
.drawer--side-left .drawer__panel,
.drawer--side-right .drawer__panel {
  touch-action: pan-y; /* Allow vertical scroll, capture horizontal drag */
  cursor: grab;
}

.drawer--side-top .drawer__panel,
.drawer--side-bottom .drawer__panel {
  touch-action: none; /* Capture all touch events for our drag logic */
  overscroll-behavior: none; /* Disable overscroll bounce on the panel */
  -webkit-overscroll-behavior: none; /* Safari/WebKit support */
  cursor: grab;
}

/* Allow content scrolling but prevent pull-to-refresh */
.drawer {
  overscroll-behavior: none;
  -webkit-overscroll-behavior: none;
}

/* Backdrop can disable touch since it's not content */
.drawer__backdrop {
  touch-action: none;
  overscroll-behavior: none;
  -webkit-overscroll-behavior: none;
}

.drawer__panel:active {
  cursor: grabbing;
}

/* ðŸ”¥ 3-MODE SYSTEM STYLES */

/* EXPANDED STATE: Full screen height */
.drawer--expanded.drawer--side-top .drawer__panel,
.drawer--expanded.drawer--side-bottom .drawer__panel {
  height: calc(100vh - 32px);
  border-radius: 0;
}

/* MINIMIZED STATE: Header only */
.drawer--minimized.drawer--side-bottom .drawer__panel {
  height: 80px;
  min-height: 80px;
  /* Ensure minimized drawer stays at bottom even when browser bars change */
  position: fixed !important;
  bottom: calc(var(--drawer-bottom-offset, 0px) + env(safe-area-inset-bottom, 0px)) !important;
  /* Safari-specific fixes for stable positioning */
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}

/* MINIMIZED STATE: Top drawer - Header only */
.drawer--minimized.drawer--side-top .drawer__panel {
  height: 80px;
  min-height: 80px;
  /* Ensure minimized drawer stays at top */
  position: fixed !important;
  top: 0 !important;
  /* Safari-specific fixes for stable positioning */
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}

/* CLOSING FROM MINIMIZED STATE: Proper directional sliding */
.drawer--closing-from-minimized.drawer--side-bottom .drawer__panel {
  transform: translate3d(0, 100%, 0) !important; /* Slide down */
  opacity: 0;
  transition: transform var(--_duration-medium) var(--_curve-ease-out),
              opacity var(--_duration-fast) ease-out;
}

.drawer--closing-from-minimized.drawer--side-top .drawer__panel {
  transform: translate3d(0, -100%, 0) !important; /* Slide up */
  opacity: 0;
  transition: transform var(--_duration-medium) var(--_curve-ease-out),
              opacity var(--_duration-fast) ease-out;
}

/* MINIMIZED STATE: Transparent backdrop and allow page interaction */
.drawer--minimized .drawer__backdrop {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease-out;
}

.drawer--minimized {
  overflow: visible; /* Allow page scroll */
  pointer-events: none; /* Disable drawer interactions except panel */
}

.drawer--minimized .drawer__panel {
  pointer-events: auto; /* Re-enable panel interactions */
}

/* MINIMIZED STATE: Hide drawer body/footer content */
.drawer--minimized .drawer__body,
.drawer--minimized .drawer__footer {
  display: none;
}

/* Disable overscroll on entire page when drawer is active (not minimized) */
body.drawer-active-not-minimized {
  overscroll-behavior: none;
  -webkit-overscroll-behavior: none;
  /* Prevent pull-to-refresh without breaking scroll position */
  overscroll-behavior-y: none;
  -webkit-overscroll-behavior-y: none;
}

/* ðŸ”¥ DISABLE ALL transitions during drag for real-time response */
.drawer[data-dragging="true"] .drawer__panel {
  transition: none;
  will-change: transform, height;
  backface-visibility: hidden;
  transform-style: preserve-3d;
  /* Prevent jumping during elongation effect */
  transform-box: border-box;
}

/* Ensure header remains interactive in minimized mode */
.drawer--minimized .drawer__header {
  cursor: grab;
  touch-action: none;
  user-select: none;
}

.drawer--minimized .drawer__header:active {
  cursor: grabbing;
}

/* Ensure initial translate-from-side animation is preserved */
.drawer--side-left .drawer__panel,
.drawer--side-right .drawer__panel,
.drawer--side-top .drawer__panel,
.drawer--side-bottom .drawer__panel {
  will-change: transform, opacity;
}

/* Ensure content remains clickable */
.drawer__panel > *:not(.drawer__drag-indicator) {
  pointer-events: auto;
  position: relative;
  z-index: 10;
}

/* Wrong direction drag feedback - subtle visual cue */
/* Removed wrong-direction feedback at start to prevent flicker on first touch */

/* Drag indicator - shows progress and direction */
.drawer__drag-indicator {
  position: absolute;
  z-index: 10;
  pointer-events: none;
  
  /* Base styles for all sides */
  background: var(--gray-300, #d1d5db);
  border-radius: var(--radius-full, 9999px);
}

/* Drag indicator positioning by side */
.drawer__drag-indicator[data-side="left"] {
  top: 50%;
  right: -0.5rem;
  width: 2px;
  height: 86px;
  transform: translateY(-50%);
}

.drawer__drag-indicator[data-side="right"] {
  top: 50%;
  left: -0.5rem;
  width: 2px;
  height: 86px;
  transform: translateY(-50%);
}

.drawer__drag-indicator[data-side="top"] {
  bottom: -0.8rem;
  left: 50%;
  width: 86px;
  height: 2px;
  transform: translateX(-50%);
}

.drawer__drag-indicator[data-side="bottom"] {
  top: -0.8rem;
  left: 50%;
  width: 86px;
  height: 2px;
  transform: translateX(-50%);
}

/* Progress bar within indicator */
.drawer__drag-progress {
  position: absolute;
  background: var(--accent-primary, #3b82f6);
  border-radius: inherit;
  transition: all 0.1s ease-out;
  box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
  
  /* Pulsing effect based on resistance */
  animation: dragPulse 0.3s ease-in-out infinite alternate;
}

/* Progress direction by side */
.drawer__drag-indicator[data-side="left"] .drawer__drag-progress,
.drawer__drag-indicator[data-side="right"] .drawer__drag-progress {
  bottom: 0;
  left: 0;
  right: 0;
  height: var(--progress, 0%);
}

.drawer__drag-indicator[data-side="top"] .drawer__drag-progress,
.drawer__drag-indicator[data-side="bottom"] .drawer__drag-progress {
  left: 0;
  top: 0;
  bottom: 0;
  width: var(--progress, 0%);
}

@keyframes dragPulse {
  from { 
    opacity: 0.6;
    transform: scale(1);
  }
  to { 
    opacity: 1;
    transform: scale(calc(1 + (1 - var(--resistance, 1)) * 0.2));
  }
}

/* Add subtle animations to header elements */
.drawer__header {
  border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  padding-bottom: var(--spacing-12);
  margin-bottom: var(--spacing-16);
}

@media (prefers-color-scheme: dark) {
  .drawer__header {
    border-bottom-color: rgba(255, 255, 255, 0.08);
  }
}

.drawer__title {
  font-weight: 600;
  letter-spacing: -0.025em;
}

.drawer__description {
  margin-top: var(--spacing-4);
}

.drawer__footer {
  border-top: 1px solid rgba(0, 0, 0, 0.08);
  padding-top: var(--spacing-16);
  margin-top: var(--spacing-16);
}

/* Smooth entrance animation with stagger */
.drawer--open .drawer__header {
  animation: slideInFade 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) 0.15s both;
}

.drawer--open .drawer__body {
  animation: slideInFade 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) 0.2s both;
}

.drawer--open .drawer__footer {
  animation: slideInFade 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) 0.25s both;
}

@keyframes slideInFade {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  .drawer__backdrop, .drawer__panel { transition: none; }
}

